# Detect when the antlr4rust tool JAR falls behind upstream releases.
# The JAR version is pinned manually in scripts/regenerate-antlr.sh,
# so cargo update and Dependabot don't cover it. This job files (or
# updates) a GitHub issue with the `staleness` label when we fall
# behind, and closes it when we catch up.
permissions:
  contents: read
  issues: write
on:
  schedule:
    # Weekly on Sunday at 07:07 UTC â€” upstream releases are infrequent
    # so nightly checks would be wasteful.
    - cron: '7 7 * * 0'
  push:
    branches: [main]
    paths:
      - 'src/generated/**'
      - 'scripts/regenerate-antlr.sh'
  workflow_dispatch:
name: antlr-staleness
jobs:
  antlr-staleness:
    runs-on: ubuntu-latest
    name: Check for new antlr4rust releases
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Extract the currently pinned version from the script so we
      # don't have to hard-code it in the workflow too.
      - name: Determine pinned version
        id: pinned
        run: |
          PINNED=$(grep -oP '(?<=download/)[^/]+' \
                   scripts/regenerate-antlr.sh)
          echo "version=$PINNED" >> "$GITHUB_OUTPUT"

      # Query the GitHub API for the latest release on the fork.
      - name: Check for newer release
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(gh api repos/antlr4rust/antlr4/releases/latest \
                   --jq '.tag_name')
          PINNED="${{ steps.pinned.outputs.version }}"
          if [ "$LATEST" = "$PINNED" ]; then
            echo "up_to_date=true" >> "$GITHUB_OUTPUT"
          else
            echo "up_to_date=false" >> "$GITHUB_OUTPUT"
            echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          fi

      # If a newer release exists, download it, regenerate, and check
      # whether the generated files actually changed.
      - name: Regenerate with new JAR
        if: steps.check.outputs.up_to_date == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          # Replace the JAR URL in the script with the new release.
          # The exact asset filename may differ per release, so we
          # fetch the asset list and pick the *-complete.jar.
          ASSET_URL=$(gh api \
            "repos/antlr4rust/antlr4/releases/tags/$LATEST" \
            --jq '.assets[]
                  | select(.name | endswith("-complete.jar"))
                  | .browser_download_url')
          # Download and regenerate.
          mkdir -p tmp
          curl -fSL -o tmp/antlr4-tool.jar "$ASSET_URL"
          java -jar tmp/antlr4-tool.jar -Dlanguage=Rust \
            -o src/generated -Xexact-output-dir \
            avro/share/idl_grammar/org/apache/avro/idl/Idl.g4
          # Check for meaningful changes (ignore the path comment).
          if git diff --quiet src/generated/; then
            echo "DRIFT=false" >> "$GITHUB_ENV"
          else
            echo "DRIFT=true" >> "$GITHUB_ENV"
            git diff src/generated/ > tmp/antlr-diff.txt
          fi

      # File (or update) a GitHub issue.
      - name: Create or update issue
        if: steps.check.outputs.up_to_date == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          PINNED="${{ steps.pinned.outputs.version }}"
          URL="https://github.com/antlr4rust/antlr4/releases/tag/$LATEST"
          TITLE="antlr4rust has a newer release ($LATEST)"
          {
            echo "Pinned: \`$PINNED\`"
            echo "Latest: [\`$LATEST\`]($URL)"
            echo ""
            if [ "$DRIFT" = "true" ]; then
              echo "Regenerating with the new JAR **changes** the"
              echo "generated parser. Review the diff carefully."
            else
              echo "Regenerating with the new JAR produces **no diff**"
              echo "in \`src/generated/\`. Safe to bump the version."
            fi
          } > /tmp/issue-body.md
          BODY=$(cat /tmp/issue-body.md)
          EXISTING=$(gh issue list --label staleness \
                     --search "$TITLE" --state open --json number \
                     --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            gh issue edit "$EXISTING" --body "$BODY"
          else
            gh issue create --title "$TITLE" \
              --label staleness --body "$BODY"
          fi

      # Close the staleness issue when we're already on the latest release.
      - name: Close resolved issue
        if: steps.check.outputs.up_to_date == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # The issue title includes the version, so search by the
          # stable prefix to match regardless of which version was
          # filed against.
          PINNED="${{ steps.pinned.outputs.version }}"
          EXISTING=$(gh issue list --label staleness \
                     --search "antlr4rust has a newer release" \
                     --state open --json number \
                     --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            gh issue close "$EXISTING" \
              --comment "Resolved: now pinned to \`$PINNED\`, which is the latest release."
          fi
